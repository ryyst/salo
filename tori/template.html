{% extends "base.html" %}
{% from 'macros.html' import container, card, button %}

{% block title %}{{ data.page_header }}{% endblock %}

{% block app_title %}{{ data.page_header }}{% endblock %}

{% block footer_updated %}
P√§ivitetty {{ data.updated_timestamp | default('-') }} - <a href="https://salo.fi/kulttuuri-ja-vapaa-aika/tapahtumat" target="_blank">Salon tapahtumat</a>
{% endblock %}

{% block header_extra %}
<!-- Distance filters -->
<div class="filters">
  <button class="filter-btn" data-distance="all">Kaikki</button>
  <button class="filter-btn active" data-distance="close">Keskusta (&lt;5km)</button>
  <button class="filter-btn" data-distance="nearby">L√§hist√∂ (&lt;10km)</button>
  <button class="filter-btn" data-distance="regional">Automatka (&lt;50km)</button>
</div>
{% endblock %}

{% block content %}
  <!-- Ongoing long-running events section -->
  {% if data.ongoing %}
  {% call container("section container") %}
    <div class="collapsible-header section-title" onclick="toggleOngoing()">
      <span>Meneill√§√§n</span>
      <span class="collapse-icon" id="ongoing-icon">‚ñº</span>
    </div>
    <div class="collapsible-content expanded" id="ongoing-content">
      {% for event in data.ongoing %}
        <div class="event ongoing" data-distance="{{ event.distance_category }}" data-distance-km="{{ event.distance_km }}" style="border-left: 4px solid {% if 'Kulttuuri' in event.categories %}#e83e8c{% elif 'Urheilu' in event.categories %}#28a745{% elif 'Musiikki' in event.categories %}#6610f2{% elif 'Ilmainen' in event.categories %}#20c997{% else %}#6c757d{% endif %};">
          <!-- Small image or placeholder -->
          {% if event.featured_image %}
            <img src="{{ event.featured_image }}" alt="{{ event.title }}" class="event-image" loading="lazy">
          {% else %}
            <div class="event-placeholder">üìÖ</div>
          {% endif %}

          <!-- Compressed event content -->
          <div class="event-content">
            <div class="event-title">
              {% if event.permalink %}
                <a href="{{ event.permalink }}" target="_blank">{{ event.title }}</a>
              {% else %}
                {{ event.title }}
              {% endif %}
            </div>

            <div class="event-dates">
              {{ event.days_remaining }} p√§iv√§√§ j√§ljell√§
              <span class="event-start-date">
                {% if event.excerpt %}
                  ({{ event.excerpt }})
                {% endif %}
              </span>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% endcall %}
  {% endif %}

  <!-- Upcoming events section -->
  {% if data.upcoming %}
  {% call container("section container") %}
    <h2 class="section-title">Tulevat</h2>
      {% for event in data.upcoming %}
        <div class="event upcoming card" data-distance="{{ event.distance_category }}" data-distance-km="{{ event.distance_km }}" style="border-left: 4px solid {% if 'Kulttuuri' in event.categories %}#e83e8c{% elif 'Urheilu' in event.categories %}#28a745{% elif 'Musiikki' in event.categories %}#6610f2{% elif 'Ilmainen' in event.categories %}#20c997{% else %}#6c757d{% endif %};">
          <!-- Header with image and title -->
          <div class="event-header">
            {% if event.featured_image %}
              <img src="{{ event.featured_image }}" alt="{{ event.title }}" class="event-image" loading="lazy">
            {% else %}
              <div class="event-placeholder">üìÖ</div>
            {% endif %}

            <div class="event-title">
              {% if event.permalink %}
                <a href="{{ event.permalink }}" target="_blank">{{ event.title }}</a>
              {% else %}
                {{ event.title }}
              {% endif %}
            </div>
          </div>

          <!-- Details below -->
          <div class="event-details">
            <div class="event-dates">
              {% if event.days_until_start == 0 %}
                Huomenna
              {% else %}
                {{ event.days_until_start }} p√§iv√§n p√§√§st√§
              {% endif %}
              <span class="event-start-date">
                {% if event.excerpt %}
                  ({{ event.excerpt }})
                {% endif %}
              </span>
            </div>

            {% if event.location %}
            <div class="event-location">üìç {{ event.location }}
              {% if event.distance_km > 0 %}
              <span class="event-distance">({{ event.distance_km }}km)</span>
              {% endif %}
            </div>
            {% endif %}

            {% if event.categories %}
            <div class="event-categories">
              {% for category in event.categories %}
              <span class="category">{{ category }}</span>
              {% endfor %}
            </div>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>
  {% endcall %}
  {% endif %}
{% endblock %}

{% block styles %}
<style>
  /* Override header to include filters */
  .app-header .container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
  }

  /* Event styling */
  .event {
    background: var(--color-bg-secondary);
    margin-bottom: 0.75rem;
    padding: 0rem;
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
    display: flex;
    flex-direction: column;
  }

  .event-title {
    font-size: 1rem;
    font-weight: bold;
    margin-bottom: 0;
    color: var(--color-text-primary);
    flex: 1;
    padding: 0.25rem 0.5rem;
    line-height: 1.3;
    max-height: calc(1.3em * 2);
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    text-overflow: ellipsis;
  }

  .event-title a {
    color: var(--color-link);
    text-decoration: none;
  }

  .event-title a:hover {
    color: var(--color-link-hover);
    text-decoration: underline;
  }

  .event-dates {
    color: var(--color-text-secondary);
    font-weight: 500;
    margin-bottom: 0.4rem;
    font-size: 0.8rem;
  }

  .event-location {
    color: var(--color-text-secondary);
    font-style: italic;
    font-size: 0.75rem;
    margin-bottom: 0.5rem;
  }

  .event-categories {
    display: flex;
    flex-wrap: wrap;
    gap: 0.25rem;
  }

  .category {
    background: var(--color-bg-tertiary);
    color: var(--color-text-secondary);
    padding: 0.20rem 0.5rem;
    border-radius: 20px;
    font-size: 0.6rem;
  }

  .event-image {
    align-self: baseline;
    width: 70px;
    height: 80px;
    object-fit: cover;
    border-radius: var(--radius-sm);
    flex-shrink: 0;
  }

  .event.upcoming .event-image {
    border-top-right-radius: 0;
    border-bottom-left-radius: 0;
  }

  .event-content {
    flex: 1;
  }

  .event-header {
    display: flex;
    align-items: center;
    gap: 0;
  }

  .event-details {
    display: flex;
    flex-direction: column;
    gap: 0rem;
    padding: 0.5rem;
  }

  .event-placeholder {
    width: 70px;
    height: 70px;
    background: linear-gradient(135deg, var(--color-bg-primary), var(--color-bg-tertiary));
    border-radius: var(--radius-md);
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-text-secondary);
    font-size: 1.5rem;
  }

  .filters {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .filter-btn {
    background: var(--color-bg-tertiary);
    border: 1px solid var(--border-color);
    padding: 0.5rem 1rem;
    border-radius: 20px;
    cursor: pointer;
    font-size: 0.875rem;
    color: var(--color-text-primary);
    transition: all 0.2s ease;
  }

  .filter-btn:hover {
    background: var(--color-bg-secondary);
    border-color: var(--color-accent-primary);
  }

  .filter-btn.active {
    background: var(--color-accent-primary);
    color: white;
    border-color: var(--color-accent-primary);
  }

  .event-distance {
    color: var(--color-accent-success);
    font-size: 0.8rem;
    font-weight: 500;
  }

  /* Section styling */
  .section {
    margin-bottom: 3rem;
  }

  .section-title {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--color-text-primary);
    padding-bottom: 1rem;
    max-width: 800px;
    margin: 0 auto;
  }

  /* Compressed ongoing event styles */
  .event.ongoing {
    padding: 0rem;
    margin-bottom: 0.5rem;
    gap: 0;
    flex-direction: row;
  }

  .event.ongoing a {
    text-overflow: ellipsis;
    overflow: hidden;
    max-width: 100%;
    display: inline-block;
  }

  .event.ongoing .event-image {
    align-self: center;
    width: 60px;
    height: 60px;
  }

  .event.ongoing .event-content {
    align-content: center;
    padding: 0.25rem 0.5rem;
    overflow: hidden;
  }

  .event.ongoing .event-placeholder {
    width: 60px;
    height: 60px;
    font-size: 1.5rem;
  }

  .event.ongoing .event-title {
    font-size: 0.8rem;
    margin-bottom: 0.15rem;
    white-space: nowrap;
    text-overflow: ellipsis;
    overflow: hidden;
    max-width: 100%;
    padding: 0;
  }

  .event.ongoing .event-dates {
    font-size: 0.7rem;
    margin-bottom: 0;
  }

  .event-start-date {
    color: var(--color-text-muted);
    font-size: 0.7rem;
    font-weight: normal;
    margin-top: 0.25rem;
  }

  /* Collapsible section styling */
  .collapsible-header {
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .collapsible-header:hover {
    color: var(--color-link);
  }

  .collapse-icon {
    transition: transform 0.2s ease;
    font-size: 1.2rem;
    margin-left: -4px;
  }

  .collapse-icon.collapsed {
    transform: rotate(-90deg);
  }

  .collapsible-content {
    overflow: hidden;
    transition: max-height 0.3s ease-out;
  }

  .collapsible-content.collapsed {
    max-height: 0;
  }

  .collapsible-content.expanded {
    max-height: 10000px;
  }
</style>
{% endblock %}

{% block scripts %}
<script>
  // Apply initial filter immediately to prevent flash
  const events = document.querySelectorAll('.event');

  events.forEach(event => {
    const distanceKm = parseFloat(event.getAttribute('data-distance-km')) || 0;
    // Apply the default "close" filter (<5km) immediately
    if (distanceKm > 5) {
      event.style.display = 'none';
    }
  });
</script>

<script>
  // Simple accordion toggle for ongoing events
  function toggleOngoing() {
    const content = document.getElementById('ongoing-content');
    const icon = document.getElementById('ongoing-icon');

    if (content.classList.contains('collapsed')) {
      content.classList.remove('collapsed');
      content.classList.add('expanded');
      icon.classList.remove('collapsed');
    } else {
      content.classList.remove('expanded');
      content.classList.add('collapsed');
      icon.classList.add('collapsed');
    }
  }

  // Apply distance filter function
  function applyDistanceFilter(selectedDistance) {
    const events = document.querySelectorAll('.event');

    events.forEach(event => {
      const distanceKm = parseFloat(event.getAttribute('data-distance-km')) || 0;
      let shouldShow = false;

      if (selectedDistance === 'all') {
        shouldShow = true;
      } else if (selectedDistance === 'close' && distanceKm <= 5) {
        shouldShow = true;
      } else if (selectedDistance === 'nearby' && distanceKm <= 10) {
        shouldShow = true;
      } else if (selectedDistance === 'regional' && distanceKm <= 50) {
        shouldShow = true;
      }

      event.style.display = shouldShow ? 'flex' : 'none';
    });
  }

  // Handle filter button clicks
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      // Update active button
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      this.classList.add('active');

      // Apply the filter
      const selectedDistance = this.getAttribute('data-distance');
      applyDistanceFilter(selectedDistance);
    });
  });
</script>
{% endblock %}
