{% extends "base.html" %}
{% from 'macros.html' import container, card, button %}

{% block title %}{{ data.page_header }}{% endblock %}

{% block app_title %}{{ data.page_header }}{% endblock %}

{% block footer_updated %}
P√§ivitetty {{ data.updated_timestamp | default('-') }} - <a href="https://salo.fi/kulttuuri-ja-vapaa-aika/tapahtumat" target="_blank">Salon tapahtumat</a>
{% endblock %}

{% block header_extra %}
<!-- Distance filters -->
<div class="filters">
  <button class="filter-btn active" data-distance="close">Keskusta (&lt;5km)</button>
  <button class="filter-btn" data-distance="nearby">L√§hist√∂ (&lt;10km)</button>
  <button class="filter-btn" data-distance="all">Kaikki</button>
</div>
{% endblock %}

{% block content %}
  <div id="favorites-area"></div>
  <!-- Ongoing long-running events section -->
  {% if data.ongoing %}
  {% call container("section container") %}
    <div class="collapsible-header section-title" onclick="toggleOngoing()">
      <span>Meneill√§√§n</span>
      <span class="collapse-icon" id="ongoing-icon">‚ñº</span>
    </div>
    <div class="collapsible-content expanded" id="ongoing-content">
      {% for event in data.ongoing %}
        <div class="event ongoing" data-distance="{{ event.distance_category }}" data-distance-km="{{ event.distance_km if event.distance_km is not none else '' }}" style="border-left: 4px solid {% if 'Kulttuuri' in event.categories %}#e83e8c{% elif 'Urheilu' in event.categories %}#28a745{% elif 'Musiikki' in event.categories %}#6610f2{% elif 'Ilmainen' in event.categories %}#20c997{% else %}#6c757d{% endif %};">
          <!-- Small image or placeholder -->
          {% if event.featured_image %}
            <img src="{{ event.featured_image }}" alt="{{ event.title }}" class="event-image" loading="lazy">
          {% else %}
            <div class="event-placeholder">üìÖ</div>
          {% endif %}

          <!-- Compressed event content -->
          <div class="event-content">
            <div class="event-title">
              {% if event.permalink %}
                <a href="{{ event.permalink }}" target="_blank">{{ event.title }}</a>
              {% else %}
                {{ event.title }}
              {% endif %}
            </div>

            <div class="event-dates">
              {% if event.days_remaining == 0 and event.duration_days == 0 %}
                Juuri nyt
              {% elif event.days_remaining == 0 %}
                P√§√§ttyy t√§n√§√§n
              {% elif event.days_remaining == 1 %}
                P√§√§ttyy huomenna
              {% else %}
                {{ event.days_remaining }} p√§iv√§√§ j√§ljell√§
              {% endif %}
              <span class="event-start-date">
                {% if event.excerpt %}
                  ({{ event.excerpt }})
                {% endif %}
              </span>
            </div>
          </div>

          <!-- Star button for favoriting -->
          <button class="star-btn" data-event-id="{{ event.id }}" onclick="toggleFavorite({{ event.id }})">
            ‚òÜ
          </button>
        </div>
      {% endfor %}
    </div>
  {% endcall %}
  {% endif %}

  <!-- Upcoming events section -->
  {% if data.upcoming %}
  {% call container("section container") %}
    <h2 class="section-title">Tulevat</h2>
      {% for event in data.upcoming %}
        <div class="event upcoming card" data-distance="{{ event.distance_category }}" data-distance-km="{{ event.distance_km if event.distance_km is not none else '' }}" style="border-left: 4px solid {% if 'Kulttuuri' in event.categories %}#e83e8c{% elif 'Urheilu' in event.categories %}#28a745{% elif 'Musiikki' in event.categories %}#6610f2{% elif 'Ilmainen' in event.categories %}#20c997{% else %}#6c757d{% endif %};">
          <!-- Image -->
          {% if event.featured_image %}
            <img src="{{ event.featured_image }}" alt="{{ event.title }}" class="event-image" loading="lazy">
          {% else %}
            <div class="event-placeholder">üìÖ</div>
          {% endif %}

          <!-- Content wrapper -->
          <div class="event-content">
            <div class="event-title">
              {% if event.permalink %}
                <a href="{{ event.permalink }}" target="_blank">{{ event.title }}</a>
              {% else %}
                {{ event.title }}
              {% endif %}
            </div>

            <div class="event-meta">
              <div class="event-dates">
                {% if event.days_until_start == 0 %}
                  T√§n√§√§n
                {% elif event.days_until_start == 1 %}
                  Huomenna
                {% else %}
                  {{ event.days_until_start }} p√§iv√§n p√§√§st√§
                {% endif %}
                <span class="event-start-date">
                  {% if event.excerpt %}
                    ({{ event.excerpt }})
                  {% endif %}
                </span>
              </div>

              {% if event.location %}
              <div class="event-location">{{ event.location }}
                {% if event.distance_km is not none and event.distance_km > 0 %}
                <span class="event-distance">({{ event.distance_km }}km)</span>
                {% endif %}
              </div>
              {% endif %}

              {% if event.categories %}
              <div class="event-categories">
                {% for category in event.categories %}
                <span class="category">{{ category }}</span>
                {% endfor %}
              </div>
              {% endif %}
            </div>
          </div>

          <!-- Star button for favoriting -->
          <button class="star-btn" data-event-id="{{ event.id }}" onclick="toggleFavorite({{ event.id }})">
            ‚òÜ
          </button>
        </div>
      {% endfor %}
    </div>
  {% endcall %}
  {% endif %}
{% endblock %}

{% block styles %}
<style>
  /* Override header to include filters */
  .app-header .container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
  }

  /* Event styling */
  .event {
    background: var(--color-bg-secondary);
    margin-bottom: 0.75rem;
    padding: 0rem;
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
    display: flex;
    flex-direction: column;
    position: relative;
  }

  /* Upcoming events - horizontal layout */
  .event.upcoming {
    flex-direction: row;
    align-items: flex-start;
    padding: 0.75rem;
    gap: 0;
  }

  .event-title {
    font-size: 1rem;
    font-weight: bold;
    margin-bottom: 0;
    color: var(--color-text-primary);
    flex: 1;
    line-height: 1.3;
    max-height: calc(1.3em * 2);
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    text-overflow: ellipsis;
  }

  .event-title a {
    color: var(--color-link);
    text-decoration: none;
  }

  .event-title a:hover {
    color: var(--color-link-hover);
    text-decoration: underline;
  }

  .event-dates {
    color: var(--color-text-secondary);
    font-weight: 500;
    margin-bottom: 0.4rem;
    font-size: 0.8rem;
  }

  .event-location {
    color: var(--color-text-secondary);
    font-style: italic;
    font-size: 0.75rem;
    margin-bottom: 0.5rem;
  }

  .event-categories {
    display: flex;
    flex-wrap: wrap;
    gap: 0.25rem;
  }

  .category {
    background: var(--color-bg-tertiary);
    color: var(--color-text-secondary);
    padding: 0.20rem 0.5rem;
    border-radius: 20px;
    font-size: 0.6rem;
  }

  .event-image {
    width: 70px;
    height: 100px;
    object-fit: cover;
    border-radius: var(--radius-sm);
    flex-shrink: 0;
  }

  .event-content {
    flex: 1;
    padding: 0.5rem;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .event.upcoming .event-content {
    padding: 0;
    padding-left: 0.75rem;
  }

  .event-meta {
    display: flex;
    flex-direction: column;
    gap: 0;
  }

  .event-placeholder {
    width: 70px;
    height: 80px;
    background: linear-gradient(135deg, var(--color-bg-primary), var(--color-bg-tertiary));
    border-radius: var(--radius-sm);
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-text-secondary);
    font-size: 1.5rem;
  }

  .filters {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .filter-btn {
    background: var(--color-bg-tertiary);
    border: 1px solid var(--border-color);
    padding: 0.5rem 1rem;
    border-radius: 20px;
    cursor: pointer;
    font-size: 0.875rem;
    color: var(--color-text-primary);
    transition: all 0.2s ease;
  }

  .filter-btn:hover {
    background: var(--color-bg-secondary);
    border-color: var(--color-accent-primary);
  }

  .filter-btn.active {
    background: var(--color-accent-primary);
    color: white;
    border-color: var(--color-accent-primary);
  }

  .event-distance {
    color: var(--color-accent-success);
    font-size: 0.8rem;
    font-weight: 500;
  }

  /* Section styling */
  #ongoing-content {
    margin-bottom: 1.5rem;
  }
  #ongoing-content.collapsed {
    margin-bottom: 0rem;
  }

  /* Favorites section styling - same as ongoing */
  #favorites-content {
    margin-bottom: 1.5rem;
  }
  #favorites-content.collapsed {
    margin-bottom: 0rem;
  }

  .section-title {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--color-text-primary);
    padding-bottom: 1rem;
    max-width: 800px;
    margin: 0 auto;
  }

  /* Compressed ongoing event styles */
  .event.ongoing {
    padding: 0rem !important;
    margin-bottom: 0.5rem;
    gap: 0 !important;
    flex-direction: row !important;
  }

  .event.ongoing a {
    text-overflow: ellipsis;
    overflow: hidden;
    max-width: 100%;
    display: inline-block;
  }

  .event.ongoing .event-image {
    align-self: center;
    width: 60px;
    height: 60px;
  }

  .event.ongoing .event-content {
    align-content: center;
    padding: 0.25rem 0.5rem !important;
    overflow: hidden;
    display: block !important;
    gap: unset !important;
  }

  .event.ongoing .event-placeholder {
    width: 60px;
    height: 60px;
    font-size: 1.5rem;
  }

  .event.ongoing .event-title {
    font-size: 0.8rem;
    margin-bottom: 0.15rem;
    white-space: nowrap;
    text-overflow: ellipsis;
    overflow: hidden;
    max-width: 100%;
    padding: 0;
  }

  .event.ongoing .event-dates {
    font-size: 0.7rem;
    margin-bottom: 0;
  }

  .event-start-date {
    color: var(--color-text-muted);
    font-size: 0.7rem;
    font-weight: normal;
    margin-top: 0.25rem;
  }

  /* Collapsible section styling */
  .collapsible-header {
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .collapsible-header:hover {
    color: var(--color-link);
  }

  .collapse-icon {
    transition: transform 0.2s ease;
    font-size: 1.2rem;
    margin-left: -4px;
  }

  .collapse-icon.collapsed {
    transform: rotate(-90deg);
  }

  .collapsible-content {
    overflow: hidden;
  }

  .collapsible-content.collapsed {
    max-height: 0;
  }

  .collapsible-content.expanded {
    max-height: 10000px;
  }

  /* Star button styling */
  .star-btn {
    position: absolute;
    bottom: 0.25rem;
    right: 0.25rem;
    width: 24px;
    height: 24px;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 16px;
    color: var(--color-text-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    z-index: 10;
    border-radius: 4px;
  }

  .star-btn:hover {
    background: var(--color-bg-tertiary);
    transform: scale(1.1);
  }

  .star-btn.favorited {
    color: #ffc107;
  }

  .star-btn.favorited:hover {
    background: var(--color-bg-tertiary);
  }
</style>
{% endblock %}

{% block scripts %}
<script>
  // Favorites Management
  class FavoritesManager {
    constructor() {
      this.storageKey = 'tori-favorites';
      this.favorites = this.loadFavorites();
      this.allEvents = []; // Store all event data for processing
    }

    loadFavorites() {
      try {
        const stored = localStorage.getItem(this.storageKey);
        return stored ? JSON.parse(stored) : [];
      } catch (error) {
        console.error('Error loading favorites:', error);
        return [];
      }
    }

    saveFavorites() {
      try {
        localStorage.setItem(this.storageKey, JSON.stringify(this.favorites));
      } catch (error) {
        console.error('Error saving favorites:', error);
      }
    }

    isFavorited(eventId) {
      return this.favorites.includes(eventId);
    }

    toggleFavorite(eventId) {
      const index = this.favorites.indexOf(eventId);
      if (index === -1) {
        this.favorites.push(eventId);
      } else {
        this.favorites.splice(index, 1);
      }
      this.saveFavorites();
      this.updateUI();
      this.renderFavorites();
    }

    getFavorites() {
      return this.favorites;
    }

    updateUI() {
      // Update all star button states and hide favorited events from original locations
      document.querySelectorAll('.star-btn').forEach(btn => {
        const eventId = parseInt(btn.getAttribute('data-event-id'));
        const isFav = this.isFavorited(eventId);
        btn.classList.toggle('favorited', isFav);
        btn.textContent = isFav ? '‚≠ê' : '‚òÜ';

        // Hide/show event in original location based on favorite status
        const eventCard = btn.closest('.event');
        if (eventCard && !eventCard.closest('#favorites-area')) {
          // Only hide events that are NOT in the favorites area
          if (isFav) {
            eventCard.style.display = 'none';
          } else {
            // Re-apply current distance filter instead of showing all
            const activeFilter = document.querySelector('.filter-btn.active');
            if (activeFilter) {
              const selectedDistance = activeFilter.getAttribute('data-distance');
              applyDistanceFilterToEvent(eventCard, selectedDistance);
            }
          }
        }
      });
    }

    // Store event data for processing favorites
    storeEventData(ongoing, upcoming) {
      this.allEvents = [...ongoing, ...upcoming];
    }

    renderFavorites() {
      // Get favorited events
      const favoritedEvents = this.allEvents.filter(event =>
        this.isFavorited(event.id)
      );

      const favoritesArea = document.getElementById('favorites-area');

      if (favoritedEvents.length === 0) {
        // Clear favorites area if no favorites
        favoritesArea.innerHTML = '';
        return;
      }

      // Generate favorites HTML
      favoritesArea.innerHTML = `
        <div class="section container">
          <div class="collapsible-header section-title" onclick="toggleFavorites()">
            <span>Seuratut</span>
            <span class="collapse-icon" id="favorites-icon">‚ñº</span>
          </div>
          <div class="collapsible-content expanded" id="favorites-content">
            ${favoritedEvents.map(event => this.renderEventCard(event)).join('')}
          </div>
        </div>
      `;

      // Update star buttons in favorites section
      favoritesArea.querySelectorAll('.star-btn').forEach(btn => {
        const eventId = parseInt(btn.getAttribute('data-event-id'));
        btn.classList.add('favorited');
        btn.textContent = '‚≠ê';
        btn.onclick = () => this.toggleFavorite(eventId);
      });
    }

    renderEventCard(event) {
      const imageHtml = event.featured_image
        ? `<img src="${event.featured_image}" alt="${event.title}" class="event-image" loading="lazy">`
        : `<div class="event-placeholder">üìÖ</div>`;

      const titleHtml = event.permalink
        ? `<a href="${event.permalink}" target="_blank">${event.title}</a>`
        : event.title;

      const isOngoing = event.event_type === 'ongoing';

      let datesHtml;
      if (isOngoing) {
        if (event.days_remaining === 0 && event.duration_days === 0) {
          datesHtml = 'Juuri nyt';
        } else if (event.days_remaining === 0) {
          datesHtml = 'P√§√§ttyy t√§n√§√§n';
        } else if (event.days_remaining === 1) {
          datesHtml = 'P√§√§ttyy huomenna';
        } else {
          datesHtml = `${event.days_remaining} p√§iv√§√§ j√§ljell√§`;
        }
      } else {
        if (event.days_until_start === 0) {
          datesHtml = 'T√§n√§√§n';
        } else if (event.days_until_start === 1) {
          datesHtml = 'Huomenna';
        } else {
          datesHtml = `${event.days_until_start} p√§iv√§n p√§√§st√§`;
        }
      }

      const excerptHtml = event.excerpt ? `<span class="event-start-date">(${event.excerpt})</span>` : '';

      let locationHtml = '';
      if (event.location) {
        const distanceHtml = (event.distance_km !== null && event.distance_km > 0) ? `<span class="event-distance">(${event.distance_km}km)</span>` : '';
        locationHtml = `<div class="event-location">${event.location} ${distanceHtml}</div>`;
      }

      let categoriesHtml = '';
      if (event.categories && event.categories.length > 0) {
        categoriesHtml = `<div class="event-categories">
          ${event.categories.map(cat => `<span class="category">${cat}</span>`).join('')}
        </div>`;
      }

      const borderColor = event.categories.includes('Kulttuuri') ? '#e83e8c' :
                          event.categories.includes('Urheilu') ? '#28a745' :
                          event.categories.includes('Musiikki') ? '#6610f2' :
                          event.categories.includes('Ilmainen') ? '#20c997' : '#6c757d';

      return `
        <div class="event ${event.event_type} ${isOngoing ? '' : 'card'}"
             data-distance="${event.distance_category}"
             data-distance-km="${event.distance_km || ''}"
             style="border-left: 4px solid ${borderColor};">
          ${imageHtml}
          <div class="event-content">
            <div class="event-title">${titleHtml}</div>
            ${isOngoing ? `
              <div class="event-dates">${datesHtml} ${excerptHtml}</div>
            ` : `
              <div class="event-meta">
                <div class="event-dates">${datesHtml} ${excerptHtml}</div>
                ${locationHtml}
                ${categoriesHtml}
              </div>
            `}
          </div>
          <button class="star-btn favorited" data-event-id="${event.id}">‚≠ê</button>
        </div>
      `;
    }
  }

  // Initialize favorites manager
  const favoritesManager = new FavoritesManager();

  // Global function for star button clicks
  function toggleFavorite(eventId) {
    favoritesManager.toggleFavorite(eventId);
  }

  // Apply initial filter immediately to prevent flash
  const events = document.querySelectorAll('.event');

  events.forEach(event => {
    // Skip events in favorites area
    if (event.closest('#favorites-area')) {
      return;
    }

    const distanceCategory = event.getAttribute('data-distance');
    // Apply the default "close" filter (<5km) immediately, hide events without location data
    if (distanceCategory === 'unknown' || distanceCategory !== 'close') {
      event.style.display = 'none';
    }
  });
</script>

<script>
  // Simple accordion toggle for ongoing events
  function toggleOngoing() {
    const content = document.getElementById('ongoing-content');
    const icon = document.getElementById('ongoing-icon');

    if (content.classList.contains('collapsed')) {
      content.classList.remove('collapsed');
      content.classList.add('expanded');
      icon.classList.remove('collapsed');
    } else {
      content.classList.remove('expanded');
      content.classList.add('collapsed');
      icon.classList.add('collapsed');
    }
  }

  // Simple accordion toggle for favorites
  function toggleFavorites() {
    const content = document.getElementById('favorites-content');
    const icon = document.getElementById('favorites-icon');

    if (content.classList.contains('collapsed')) {
      content.classList.remove('collapsed');
      content.classList.add('expanded');
      icon.classList.remove('collapsed');
    } else {
      content.classList.remove('expanded');
      content.classList.add('collapsed');
      icon.classList.add('collapsed');
    }
  }

  // Helper function to apply distance filter to a single event
  function applyDistanceFilterToEvent(event, selectedDistance) {
    const distanceCategory = event.getAttribute('data-distance');
    const distanceKm = parseFloat(event.getAttribute('data-distance-km'));
    const eventId = parseInt(event.querySelector('.star-btn').getAttribute('data-event-id'));
    const isFavorited = favoritesManager.isFavorited(eventId);

    // Don't show favorited events in original locations
    if (isFavorited) {
      event.style.display = 'none';
      return;
    }

    let shouldShow = false;
    if (selectedDistance === 'all') {
      shouldShow = true;  // Show all events, including those without GPS data
    } else if (distanceCategory === 'unknown') {
      shouldShow = false;  // Hide events without GPS data in distance filters
    } else if (selectedDistance === 'close' && distanceCategory === 'close') {
      shouldShow = true;
    } else if (selectedDistance === 'nearby' && ['close', 'nearby'].includes(distanceCategory)) {
      shouldShow = true;
    }

    event.style.display = shouldShow ? 'flex' : 'none';
  }

  // Apply distance filter function
  function applyDistanceFilter(selectedDistance) {
    const events = document.querySelectorAll('.event');

    events.forEach(event => {
      // Skip events in favorites area
      if (event.closest('#favorites-area')) {
        return;
      }

      applyDistanceFilterToEvent(event, selectedDistance);
    });
  }

  // Handle filter button clicks
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      // Update active button
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      this.classList.add('active');

      // Apply the filter
      const selectedDistance = this.getAttribute('data-distance');
      applyDistanceFilter(selectedDistance);
    });
  });
</script>

<script>
  // Initialize favorites on page load
  document.addEventListener('DOMContentLoaded', function() {
    // Pass event data to favorites manager
    const ongoingEvents = {{ data.ongoing | tojson | safe }};
    const upcomingEvents = {{ data.upcoming | tojson | safe }};

    favoritesManager.storeEventData(ongoingEvents, upcomingEvents);
    favoritesManager.updateUI();
    favoritesManager.renderFavorites();
  });
</script>
{% endblock %}
